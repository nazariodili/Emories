<!doctype html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <title>La tua storia</title>

    <!-- üåê Tailwind CSS + Tone.js per audio -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@latest/build/Tone.js"></script>
  </head>

  <body class="bg-gray-100 p-6 text-gray-800">
    <div class="max-w-3xl mx-auto">
      <!-- üîô Link per tornare alla home -->
      <a href="index.html" class="text-blue-600">‚Üê Torna alla home</a>

      <!-- üè∑Ô∏è Titolo dinamico della storia -->
      <h1 id="storyTitle" class="text-2xl font-bold mt-4">Caricamento...</h1>

      <!-- üéõÔ∏è CONTROLLI AUDIO -->
      <div class="flex items-center gap-2 my-4">
        <button id="playPause" class="px-4 py-2 bg-blue-600 text-white rounded">
          ‚ñ∂Ô∏è
        </button>
        <button id="seekBack" class="px-2 py-1 bg-gray-200 rounded">
          ‚è™ 10s
        </button>
        <button id="seekForward" class="px-2 py-1 bg-gray-200 rounded">
          10s ‚è©
        </button>
        <input
          id="timelineSlider"
          type="range"
          min="0"
          value="0"
          step="0.01"
          class="w-full mx-2"
        />
        <span id="currentTime" class="text-sm">00:00</span>
        <span id="remainingTime" class="text-sm text-gray-500">‚Äì00:00</span>
      </div>

      <!-- üéöÔ∏è SELECT PRESET -->
      <select id="presetSelect" class="mb-4 p-2 border rounded"></select>

      <!-- üìú TESTO NARRATO SINCRONIZZATO -->
      <div
        id="storyText"
        class="whitespace-pre-line text-lg bg-white p-4 rounded shadow max-h-[400px] overflow-y-auto"
      ></div>
    </div>

    <!-- üîå JS MODULE: carica tutto in modo asincrono -->
    <script type="module">
      import { destroyPreviousMix, setupNarrationSequenceToneJS } from "./audioEngine.js";
      import { setupSyncText } from "./syncText.js";

      // üì¶ Recupera l'ID storia dall'URL
      const storyId = new URLSearchParams(location.search).get("id");

      // üì• Carica metadati e transcript della storia
      const metadata = await fetch(`/api/stories/${storyId}`).then((res) => res.json());
      const transcript = await fetch(`/stories/${storyId}/transcript.json`).then((res) => res.json());

      // üè∑Ô∏è Mostra il titolo nel DOM
      document.getElementById("storyTitle").innerText = metadata.title || "Senza titolo";

      // üéöÔ∏è Carica la lista dei preset disponibili
      const presetSelect = document.getElementById("presetSelect");
      const presetList = await fetch("/api/presets").then((res) => res.json());

      // üß© Popola la select dinamicamente
      presetList.forEach((presetName) => {
        const option = document.createElement("option");
        option.value = presetName;
        option.textContent = presetName;
        presetSelect.appendChild(option);
      });

      // üéØ Imposta il preset attuale da metadata, con fallback
      const selectedPreset =
        metadata.preset && presetList.includes(metadata.preset)
          ? metadata.preset
          : "dreamy";
      presetSelect.value = selectedPreset;

      // üîÑ Funzione per caricare preset, sincronizzazione e audio
      async function loadPresetAndStart(presetName) {
        destroyPreviousMix(); // üßº Reset prima del nuovo mix

        const presetModule = await import(`./presets/${presetName}.js`);
        const preset = presetModule[`${presetName}Preset`];
        const startDelay = preset.startDelay ?? 0;

        // üìù Sincronizza testo narrato
        setupSyncText("storyText", transcript.segments, startDelay);

        // üéß Avvia audio con Tone.js
        setupNarrationSequenceToneJS(storyId, preset);
      }

      // ‚ñ∂Ô∏è Avvio iniziale
      await loadPresetAndStart(selectedPreset);

      // üîÅ Cambio preset dinamico (una sola volta, qui sotto correttamente)
      presetSelect.addEventListener("change", async (e) => {
        const newPreset = e.target.value;
        await loadPresetAndStart(newPreset);
      });

    </script>
  </body>
</html>
